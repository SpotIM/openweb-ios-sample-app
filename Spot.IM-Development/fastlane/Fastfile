# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "dmjq-rohv-jwmk-fcxi"
ENV["MATCH_PASSWORD"] = "iOSOpenwebPrivateKeydfdskdfnlwqijeakpnqs"

default_platform(:ios)

git_url = "git@github.com:SpotIM/openweb-ios-certs.git"

platform :ios do

  desc "The setup_circle_ci fastlane action will perform the following actions:
  Create a new temporary keychain for use with match (see the CircleCI code signing doc for more details).
  Switch match to readonly mode to make sure CI does not create new code signing certificates or provisioning profiles.
  Set up log and test result paths to be easily collectible."
  before_all do
    puts "in setup_circle_ci"
    setup_circle_ci
  end

  desc "Push a new beta build to TestFlight"
  lane :beta do
    match(type: "appstore", readonly: true)
    match(type: "development", readonly: true)
    increment_build_number(build_number: Time.now.to_i.to_s[0..7])
    build_app(workspace: "Spot-IM.Development.xcworkspace", scheme: "Spot-IM.Development")
    upload_to_testflight
  end

  lane :unit_tests do |options|
    cocoapods()
    scan(
      scheme: "Spot-IM.DevelopmentTests",
      workspace: "Spot-IM.Development.xcworkspace",
      device: "iPhone 12 Pro",
    )
  end

  lane :release_pod do |options|
    increment_build_number()
    increment_version_number(version_number: options[:version]) # Set a specific version number)
    build_release_sdk()
  end

  lane :build_release_sdk do
    cocoapods(use_bundle_exec: false)
    xcodebuild(
      scheme: "Package SpotImCoreSDK",
      configuration: "Release",
      destination: "generic/platform=iOS",
      clean: true,
      build: true
    )
  end

  lane :prepare_demo_app do
    match(type: "appstore", readonly: true)
    match(type: "development", readonly: true)
    increment_build_number_in_xcodeproj

    build_app(workspace: "Spot-IM.Development.xcworkspace",
      scheme: "Spot-IM.Development",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
            "im.spot.demo" => "match AppStore im.spot.demo"
        }
    })
  end

  lane :release_demo_app do |options|
    increment_build_number()
    increment_version_number(version_number: options[:version]) # Set a specific version number
    increment_version_number_in_xcodeproj(version_number: options[:version])
    match(
        type: "appstore",
        readonly: true,
        api_key_path: "apple_api_key.json"
    )
    match(type: "development", readonly: true)
    cocoapods(use_bundle_exec: false)
    gym(
        scheme: "Spot-IM.Development",
        workspace: "Spot-IM.Development.xcworkspace",
        export_method: "app-store",
        export_options: {
            signingStyle: "manual",
            provisioningProfiles: {
                "im.spot.demo" => "match AppStore im.spot.demo"
            }
        },
        xcargs: "-allowProvisioningUpdates"
    )
    upload_to_testflight(api_key_path: "apple_api_key.json")
  end
  
  lane :release_public_demo_app do |options|
    public_sample_app_build_threshold = 100
    build_number = get_build_number()
    puts build_number
    if build_number.to_i < public_sample_app_build_threshold.to_i
      puts "Increment build number to 100 for public sample app"
      increment_build_number(build_number: public_sample_app_build_threshold)
    end
    increment_build_number()
    increment_version_number(version_number: options[:version]) # Set a specific version number
    increment_version_number_in_xcodeproj(version_number: options[:version])
    match(
        type: "appstore",
        readonly: true,
        api_key_path: "apple_api_key.json"
    )
    match(type: "development", readonly: true)
    cocoapods(use_bundle_exec: false)
    gym(
        scheme: "Spot-IM.PublicDemoApp",
        workspace: "Spot-IM.Development.xcworkspace",
        export_method: "app-store",
        export_options: {
            signingStyle: "manual",
            provisioningProfiles: {
                "im.spot.demo" => "match AppStore im.spot.demo"
            }
        },
        xcargs: "-allowProvisioningUpdates"
    )
    upload_to_testflight(api_key_path: "apple_api_key.json")
  end

  lane :bump_version do
    increment_version_number_in_xcodeproj(
      bump_type: 'patch',
      scheme: 'Spot-IM.Development'
    )
    increment_build_number_in_xcodeproj
  end
end
