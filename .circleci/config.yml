# For a detailed guide to building and testing on iOS, read the docs:
# https://circleci.com/docs/2.0/testing-ios/

version: 2.1

references:
  # Docker image configurations
  ios_config_xcode: &ios_config_xcode
    parameters:
      xcode:
        type: string
    macos:
      xcode: << parameters.xcode >>
    working_directory: ~/project/Spot.IM-Development

  define_var_release_version: &define_var_release_version
    run:
      name: Export new version number to environment variable
      command: |
        echo "export RELEASE_VERSION=$(cut -d '/' -f3 \<<< $CIRCLE_BRANCH)" \>> $BASH_ENV
        echo $RELEASE_VERSION

  define_var_core_version: &define_var_core_version
    run:
      name: Export core version number to environment variable
      command: |
        echo "export CORE_VERSION=$(cut -d '/' -f4 \<<< $CIRCLE_BRANCH)" \>> $BASH_ENV
        echo $CORE_VERSION

commands:
  release_tag:
    steps:
      - checkout:
          path: ~/project

      - *define_var_release_version

      - run:
          name: start release tag build
          command: |
            echo "Start release tag build $RELEASE_VERSION"
            pwd
            ls -l

      - restore_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}

      - restore_cache:
          key: bundler_cache_tamBiFKNEwk5ZF1vK4zAgATUGFUqItRwE1YYO8v9szM=

      - run:
          name: Bundle Install
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - save_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}
          paths:
            - "vendor/bundle"

      - run:
          name: Before Running Fastlane Build Release
          command: |
            git status

      - run:
          name: Run Fastlane Build Release
          command: |
            bundle exec fastlane build_release_sdk version:$RELEASE_VERSION

      - run:
          name: After Running Fastlane Release
          command: |
            ls -l Release
            git status

  swiftlint:
    steps:
      - run:
          name: Install Homebrew
          command: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - run:
          name: Install SwiftLint
          command: |
            brew update
            brew install swiftlint
            swiftlint version

      - run:
          name: Run SwiftLint
          command: |
            swiftlint lint --strict --config swiftlint/.swiftlint.yml --reporter xcode || (echo "SwiftLint check failed." && exit 1)
            echo "SwiftLint check succeeded."

  prepare_release_app:
    steps:
      - checkout:
          path: ~/project

      - *define_var_release_version

      - run:
          name: start release app
          command: |
            echo "Start release app version: $RELEASE_VERSION"
            pwd
            ls -l

      - run:
          name: Configure Apple Key
          command: |
            sed -i '' -e "s/@@@@/${APPLE_KEY}/g" apple_api_key.json

      - restore_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}

      - restore_cache:
          key: bundler_cache_tamBiFKNEwk5ZF1vK4zAgATUGFUqItRwE1YYO8v9szM=

      - run:
          name: Bundle Install
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - save_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}
          paths:
            - "vendor/bundle"

      - swiftlint

orbs:
  aws-s3: circleci/aws-s3@3.0.0
  slack: circleci/slack@3.4.2
  codecov: codecov/codecov@3.2.2

jobs:
  validate_spm_job:
    <<: *ios_config_xcode
    steps:
      - checkout:
          path: ~/project

      - *define_var_core_version

      - run:
          name: Clone SPM integration repo
          command: |
            mkdir spm-integration
            cd spm-integration
            git clone https://github.com/SpotIM/iOS-SDK-Test-SPM-Integration.git
            ls -l

      - run:
          name: Change xcode project SpotIM SPM version to the branch validate version requested and commit
          command: |
            cd spm-integration/iOS-SDK-Test-SPM-Integration
            ls -l
            git branch validate/spm/sdk/$CORE_VERSION
            git checkout validate/spm/sdk/$CORE_VERSION
            git status
            sed -i '' "s/\branch = .*/branch = $CORE_VERSION;/" OpenWeb-iOS-SDK-Demo.xcodeproj/project.pbxproj
            git add .
            git commit -m "validate spm with version '$CORE_VERSION'"

      - run:
          name: Bundle Install
          command: |
            cd spm-integration/iOS-SDK-Test-SPM-Integration
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - run:
          name: Build app
          command: |
            cd spm-integration/iOS-SDK-Test-SPM-Integration
            bundle exec fastlane build

      - run:
          name: Create a pull request on Github for validating cocoapods integration
          command: |
            cd spm-integration/iOS-SDK-Test-SPM-Integration
            git push origin validate/spm/sdk/$CORE_VERSION

      # Collect XML test results data to show in the UI, and save the same XML
      # files under test-results folder in the Artifacts tab
      - store_test_results:
          path: fastlane
      - store_artifacts:
          path: fastlane
          destination: scan-output

  validate_cocoapods_job:
    <<: *ios_config_xcode
    steps:
      - checkout:
          path: ~/project

      - *define_var_core_version

      - run:
          name: Clone cocoapods integration repo
          command: |
            mkdir cocoapods-integration
            cd cocoapods-integration
            git clone https://github.com/SpotIM/iOS-SDK-Test-Cocoapods-Integration.git
            ls -l

      - run:
          name: Change podfile SpotIM version to the branch validate version requested and commit
          command: |
            cd cocoapods-integration/iOS-SDK-Test-Cocoapods-Integration
            ls -l
            git branch validate/cocoapods/sdk/$CORE_VERSION
            git checkout validate/cocoapods/sdk/$CORE_VERSION
            git status
            sed -i '' "s/\pod 'SpotIMCore'.*/pod 'SpotIMCore', '$CORE_VERSION'/" Podfile
            git add .
            git commit -m "validate cocoapods with version '$CORE_VERSION'"

      - run:
          name: Pod install
          command: |
            cd cocoapods-integration/iOS-SDK-Test-Cocoapods-Integration
            pod install

      - run:
          name: Bundle Install
          command: |
            cd cocoapods-integration/iOS-SDK-Test-Cocoapods-Integration
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - run:
          name: Build app
          command: |
            cd cocoapods-integration/iOS-SDK-Test-Cocoapods-Integration
            bundle exec fastlane build

      - run:
          name: Create a pull request on Github for validating cocoapods integration
          command: |
            cd cocoapods-integration/iOS-SDK-Test-Cocoapods-Integration
            git push origin validate/cocoapods/sdk/$CORE_VERSION

      # Collect XML test results data to show in the UI, and save the same XML
      # files under test-results folder in the Artifacts tab
      - store_test_results:
          path: fastlane
      - store_artifacts:
          path: fastlane
          destination: scan-output

  default_job:
    <<: *ios_config_xcode
    steps:
      - checkout:
          path: ~/project
      - run:
          name: Bash
          command: |
            pwd
            ls -l
      - run:
          name: start default build
          command: |
            echo "Start deafult build"
            pwd
            ls -l

      - restore_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}

      - restore_cache:
          key: bundler_cache_tamBiFKNEwk5ZF1vK4zAgATUGFUqItRwE1YYO8v9szM=

      - run:
          name: Bundle Install
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - save_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}
          paths:
            - "vendor/bundle"

      - swiftlint

      - run:
          name: Build app and run unit-tests
          command: |
            bundle exec fastlane unit_tests

      # Collect XML test results data to show in the UI, and save the same XML
      # files under test-results folder in the Artifacts tab
      - store_test_results:
          path: test_output
      - store_artifacts:
          path: test_output
          destination: scan-output

  release_sdk_job:
    <<: *ios_config_xcode
    steps:
      - checkout:
          path: ~/project

      - *define_var_release_version

      - run:
          name: start release build
          command: |
            echo "Start release build $RELEASE_VERSION"
            pwd
            ls -l

      - restore_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}

      - restore_cache:
          key: bundler_cache_tamBiFKNEwk5ZF1vK4zAgATUGFUqItRwE1YYO8v9szM=

      - run:
          name: Bundle Install
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
            bundle info fastlane

      - save_cache:
          key: bundler_cache_{{ checksum "Gemfile.lock" }}
          paths:
            - "vendor/bundle"

      - run:
          name: Before Running Fastlane Release
          command: |
            git status

      - run:
          name: Run Fastlane Release
          command: |
            bundle exec fastlane build_release_sdk version:$RELEASE_VERSION

      - swiftlint

      - run:
          name: After Running Fastlane Release
          command: |
            ls -l Release
            git status

      - run:
          name: Update Github repo with new SDK version
          command: |
            bash -x ./commit_and_push_changes.sh $RELEASE_VERSION $CIRCLE_BRANCH

      - run:
          name: Create a pull request on Github for the new release
          command: |
            bash -x ./create_pull_request_for_release.sh $RELEASE_VERSION $CIRCLE_BRANCH

      - run:
          name: Update public Github repo SpotIM/spotim-ios-sdk-pod with new SDK version
          command: |
            bash -x ./update_public_pod_repo_with_sdk.sh $RELEASE_VERSION

      - run:
          name: Create a "Github Release" on public Github repo SpotIM/spotim-ios-sdk-pod
          command: |
            bash -x ./create_new_github_release_via_api.sh $RELEASE_VERSION

  release_tag:
    <<: *ios_config_xcode
    steps:
      - prepare_release_app

      - run:
          name: Create a tag on public Github repo SpotIM/spotim-ios-sdk-pod
          command: |
            bash -x ./update_public_pod_repo_with_tag.sh $RELEASE_VERSION << parameters.xcode >>

  release_app_job:
    <<: *ios_config_xcode
    steps:
      - prepare_release_app

      - run:
          name: Run Fastlane Release Sample App
          command: |
            bundle exec fastlane release_demo_app version:$RELEASE_VERSION

  release_beta_app_job:
    <<: *ios_config_xcode
    steps:
      - prepare_release_app

      - run:
          name: Run Fastlane Release Sample App
          command: |
            bundle exec fastlane release_beta_demo_app version:$RELEASE_VERSION

  release_public_app_job:
    <<: *ios_config_xcode
    steps:
      - prepare_release_app

      - run:
          name: Run Fastlane Release Sample App
          command: |
            bundle exec fastlane release_public_demo_app version:$RELEASE_VERSION

  upload_build_to_s3_job:
    <<: *ios_config_xcode
    steps:
      - prepare_release_app

      - run:
          name: Run Fastline build .app file
          command: |
            bundle exec fastlane build_development_app

      - aws-s3/sync:
          from: simulator_build/*/Products/Applications/Spot-IM.Development.app
          to: 's3://prod-ow-mobile/iOS/internal-${RELEASE_VERSION}/Spot-IM.Development.app'
          arguments: |
            --region $AWS_REGION \
            --content-encoding "app"

      - run:
          name: Run Fastline build .ipa file
          command: |
            bundle exec fastlane build_release_ipa

      - run:
          name: Copy ipa file to folder ipa-build
          command: |
            mkdir ipa-build
            cp Spot-IM.Development.ipa ipa-build

      - aws-s3/sync:
          from: ipa-build
          to: 's3://prod-ow-mobile/iOS/internal-${RELEASE_VERSION}/Spot-IM.Development.ipa'
          arguments: |
            --region $AWS_REGION


workflows:
  version: 2
  independent_job_workflow:
    jobs:
      - upload_build_to_s3_job:
          context: mobile-automation
          filters:
            branches:
              only:
                - /^test/s3/.*/
          xcode: "14.0.0"

      - default_job:
          filters:
            branches:
              ignore:
                - /^release/.*/
                - /^validate/.*/
          xcode: "14.0.0"

      - release_sdk_job:
          filters:
            branches:
              only:
                - /^release/sdk/.*/
          xcode: "14.0.0"

      - release_tag:
          filters:
            branches:
              only:
                - /^release/tag13.4/.*/
          xcode: "13.4.0"

      - release_tag:
          filters:
            branches:
              only:
                - /^release/tag14.2/.*/
          xcode: "14.2.0"

      - release_app_job:
          filters:
            branches:
              only:
                - /^release/app/.*/
          xcode: "14.0.0"

      - release_beta_app_job:
          filters:
            branches:
              only:
                - /^release/beta_app/.*/
          xcode: "14.0.0"

      - release_public_app_job:
          filters:
            branches:
              only:
                - /^release/public_app/.*/
          xcode: "14.0.0"

  release_multi_workflow:
    jobs:
      - release_sdk_job:
          filters:
            branches:
              only:
                - /^release/multi/.*/
          xcode: "14.0.0"

      - release_tag:
          requires:
            - "release_sdk_job"
          xcode: "13.4.0"

      - release_tag:
          requires:
            - "release_sdk_job"
          xcode: "14.2.0"

  validate_workflow:
    jobs:
      - validate_cocoapods_job:
          filters:
            branches:
              only:
                - /^validate/cocoapods/sdk/.*/
          xcode: "14.0.0"
      - validate_spm_job:
          filters:
            branches:
              only:
                - /^validate/spm/sdk/.*/
          xcode: "14.0.0"
